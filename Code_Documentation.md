# Project Description
This project is conducted in the context of the internship of Daniel Wieczorek under the supervision of and with the consent of Jeroen van der Hooft, Maria Torres Vega and Hemanth Kumar Ravuri. The goal of the IAESTE internship is to provide an interactive application that allows to interact with (touch) virtual objects created from rendered point cloud video to an immersed user. The SenseGloves NOVA haptic gloves will be used to provide the interaction. Evaluate by means of subjective evaluations the degree of interactivity experienced with the different options.

## Database Description


# Prerequisites
* Basic understanding of the Unity Framework
* Basic understanding of meshes and point clouds
* Overview of the point cloud [database](http://plenodb.jpeg.org/pc/8ilabs/) used in this project

**Recommended Tutorials**
* [Beginner's Game Development Tutorial](https://www.youtube.com/watch?v=gB1F9G0JXOo&list=PLn1oz2KIN3VlErTnCwu14fRlRoCdyAIBn&index=1)

* [Introduction to VR in Unity Playlist](https://www.youtube.com/watch?v=gGYtahQjmWQ&list=RDCMUCPJlesN59MzHPPCp0Lg8sLw)

* [Optimising Games in Unity](https://www.youtube.com/watch?v=3x2DzXlBCkc)


# Requirements
## Hardware
* The machine used in this project is equipped with an Intel core i7 processor, 16 GB of RAM, and an Nvidia Geforce RTX 2070 with max-Q design.
* Oculus Quest 2 128GB
* USB-C to USB-C Cable that supports USB3.2 GEN1 with 5Gbps bandwidth.
* SenseGloves NOVA haptic gloves

## Software
### Unity Version
The unity version used for this project is 2022.1.6f1
### Packages
XR Interaction Toolkit 2.0.2
XR Plugin Management 4.2.1

# File Structure
The following documentation aims to provide a starter guide to understand the project structure. We will go through a brief description of the most relevant files and directories.

The project consists of converting the point cloud database into meshes and rendering them and point clouds on different levels of quality to compare performance. For this, we will have two main folders as follows:

```
>Project
	>PointCloud2MeshesConverter
	>Renderer
		>Assets
		>Packages
		>...
```
## PointCloud2MeshesConverter
The PointCloud2MeshesConverter is the folder that contains the python scripts to convert Point Clouds into meshes.
Its file structure is as follows:
```
>PointCloud2MeshesConverter
	>PointClouds
	>Meshes
	>Scripts
	>meshlab.py
	>README.md
```

### PointClouds
```
>PointClouds
	>RenameFiles.py
	>PointCloud
```
The original files from the downloaded dataset must be renamed to respect the following format.
```
{ObjectName}_{D1D2D3D4}.ply
```
To do that, the RenameFiles.py will take the original files from the Original_Dataset folder, rename them, and finally place them in the PointCloudsOrganized folder.


### Meshses
```
>Meshes
	>longdress
		>Stl
			>londress_0001.obj
			>londress_0001.png
			>londress_0001.tex
	>...
```

This folder contains all the frames and textures generated by the meshlab.py script. These files will later be moved to the unity project.

### Scripts
This folder contains the scripts used by the meshlab.py script to generate the meshes.

### meshlab.py
This script will be used to convert the point clouds in the PointCloudsOrganized folder and place them in the Meshes folder.

## Renderer
This folder contains the unity project used to render the point clouds and meshes. We will mostly be interested in the Assets folder.

The **Assets** folder contains all the unity project files organised as follows:
```
>Renderer
	>Assets
		>Files
		>Resources
		>Scenes
		>Scripts
		>XR
		>XRI
	>Packages
```

The following folders are default assets that are necessary for the project. There is no need to go through them in this documentation.

```
>XR
>XRI
```

### Files
```
>Files
	>SceneConfiguration
	>LoadConfiguration
	>Statistics
	>PlayerMovements
```

#### SceneConfiguration
This folder contains .cfg files with the initial coordinates of 1 to  4 meshes within the scene.
```
>Configurations
	>scene_1.cfg
	>scene_2.cfg
	>scene_3.cfg
	>scene_4.cfg
```

Each line in the configuration file represents a mesh and its coordinates within the scene using the following format:

>{Game Object Name} {Px} {Py} {Pz} {Rx} {Ry} {Rz}

Px, Py, Pz : Position of the Object
Rx, Ry, Rz : Rotation of the Object

**Example**
```
soldier 2 0 1 0 180 0
```


>It is important to note that the path of these files will be used in the "SceneCreation.cs" script. In case the file structure is changed, make sure to make the appropriate adjustments to the code.

#### LoadConfiguration
This folder contains .cfg files describing the loading quality defined by the depth of the Meshes for each sequence of frames.

Each line in the configuration file represents a sequence of frames and the depth in which they should be loaded using the following format:

>{Number of Frames} {Depth}


**Example**
```
50 8
100 7
150 6
```
The following configuration will load the first 50 frames at depth 8 followed by 100 frames at depth 7 and finally 150 frames at depth 6.

> Please note that the sum of all the frames must be less than or  equal to 300

#### Statistics
During each play, performance metrics will be saved for future evaluations. The data collected includes : Timestamp(s), FPS, RenderTime(ms), Triangles, Vertices, Distance from object
The data is saved in .csv files as follows:
{Timestamp}, {FPS}, {RenderTime}, {Triangles}, {Vertices}, {Distance}

The .csv files are saved under a specific name that reflects the conditions of the test.
#### PlayerMovements
The movements of the player will be recorded in posrot{i}.csv with i being the index of the recording. 
The movement is saved in the following format:
>{Px} {Py} {Pz} {Rx} {Ry} {Rz} {Timestamp}



### Resources
This folder contains all frames and textures necessary to create the meshes. They are organized by mesh name and depth.
```
>Resources
	>ExampleAssets
	>Meshes
	>Prefabs
```
>These files will be used in the "MeshRender.cs" script to create the meshes. In case of a change in the file structure, the path variable must be changed accordingly.

>Each character has 300 frames per depth.

#### ExampleAssets
This folder was created as part of the default Unity VR project. 

#### Meshes
This folder contains all the textures and frames needed to create the Meshes.
```
>Meshes
	>longdress
		>depth_0
			>Stl
				>longdress_0001.obj
				>longdress_0001.obj.mtl
				>longdress_0001_tex.png
				>...
		>depth_7
			>Stl
				>longdress_0001.obj
				>longdress_0001.obj.mtl
				>longdress_0001_tex.png
				>...
	>loot
		>depth_0
			>Stl
				>...
	>redandblack
		>depth_0
			>Stl
				>...
	>soldier
		>depth_0
			>Stl
				>...
```
>Any generated meshes should be included by respecting the same file structure.
>Adding new meshses to the project can take some time to load in the unity editor.

#### Prefabs
This folder contains prefabs of the characters with the necessary components attached. 

### Scenes
This folder contains all the scenes for the project. The 4Meshes folder contains the main scene with the 4 meshes present at the same time.
```
>Scenes
	>4Meshes
		>4Meshes.unity
```

>More scenes can be added to the project.

 
### Scripts
This folder contains all the scripts attached to the game objects.
```
>Scripts
	>MeshRender.cs
	>PointCloudRenderer.cs
	>Replay.cs
	>PlayerMovementsRecorder.cs
	>SceneCreation.cs
	>Offset.cs 
	>SaveStats.cs
```

#### SceneCreation
This script is attached to the "Configuration" Game Object. Based on the coordinates in the "scene_name.cfg" file, the script will extract the coordinates of each mesh and place them accordingly.

#### MeshRender
This script is attached to each mesh game object. It will load the frames and textures of each mesh following the load configuration specified.

#### PlayerMovementsRecorder
This script is attached to the "Main Camera" Game Object. It will record the movements of the Player by tracking the main camera position and save them in "Files/PlayerMovements/posrot.csv". These coordinates will be used to recreate the scene.
The movement is saved in the following format:
>{Px} {Py} {Pz} {Rx} {Ry} {Rz} {Timestamp}

#### Replay
This script is attached to the "Main Camera" Game Object. It will recreate the scene by reading the coordinates saved in  "Files/PlayerMovements/posrot.csv".

#### PointCloudRender

#### Offset
This script is attached the the "Camera Offset" Game Object and will guarantee that the scene will load from the same position and orientation angle regardless of the player's starting position in the game area.


#### SaveStats
This script is attached to the "StatsRecorder" Game Object. It records the statistics for each game and saves them in a .csv file in the "Files/Stats/" folder.
# Game Objects
In the 4Meshes Scene, game objects are organized as follows.
## Scene
### Scene Creator
**Components**
Script: SceneCreation.cs
### Plane
### Directional Light
## XRRig
### Camera Offset
**Components**
Script: Offset.cs
#### Main Camera
**Components**
Script: PlayerMovementsRecorder.cs
Script: Replay.cs
### RightController
### LeftController
## StatsRecorder
**Components**
Script: SaveStats.cs
## Characters
### soldier
**Components**
Script: MeshRender.cs
MeshRenderer
MeshFilter
### loot
**Components**
Script: MeshRender.cs
MeshRenderer
MeshFilter
### redandblack
**Components**
Script: MeshRender.cs
MeshRenderer
MeshFilter
### longdress
**Components**
Script: MeshRender.cs
MeshRenderer
MeshFilter



# Run the Project
1. Convert the PointClouds to Meshes
2. Set up the Oculus Quest Device
3. Set up the Unity Environment
4. Set up the Scene
	1. Play Mode
	2. Replay Mode
	3. Statistics

## Convert the PointClouds to Meshes
If you are starting the project from the original downloaded dataset, you will first need to convert the point clouds to meshes.
There are 300 files for each object. The original files are organized as follows:
```
>PointCloud
	>longdress
		>Ply
			>longdress_vox10_1051.ply
			>...
	>loot
	>redandblack
	>soldier
```

![](Files/1.PNG)

However, the .ply files first have to be renamed to respect the following format:
`{objectName}_{frameNumber}.ply`

To do that, navigate to the PointClouds folder. Run the RenameFiles.py script in the command prompt. 

![](Files/2.PNG)

After the code runs, you should find all files renamed as follows:

![](Files/3.PNG)


Once this is done, you can now navigate back to the main folder. Make sure that you have the pymeshlab library installed.
If not, run the following command to install it.

`pip install pymeshlab`

![](Files/4.PNG)

To run the script, you have to precise the input folder and output folder. You can also specify the depth or the character you would like to convert. However, these parameters are optional. In case no character is specified, all characters will be rendered. In case no depth is given, all depths will be rendered.

The input directory in our case is the "PointClouds/PointCloud". The output directory is "Meshes". Make sure that the output directory respects the following file structure:

```
>Meshes
	>longdress
		>Stl
	>loot
		>Stl
	>redandblack
		>Stl
	>soldier
		>Stl
```
![](Files/6.PNG)

![](Files/5.PNG)


Navigate to the main folder in the command prompt, run the following command

python meshlab.py -i {inputDirectory} -o {outputDirectory} -d {depth} -s {object}

**Examples**
![](Files/7.PNG)

The conversion can take a lot of time to finish depending on the depth and number of objects. In this case, the longdress object at depth 6 with lines took 4 hours.

![](Files/8.PNG)

Once the files are ready, go ahead and transfer them in the unity project.
![](Files/9.PNG)
![](Files/10.PNG)


> Make sure to respect the same file structure specified above

> If using the HDRP branch, the PointCloud folder follows a different format to accomodate for the inclusion of different pointCloud qualities: pointClouds/[point cloud name]/[quality value]/[.ply files].

> After adding the files to the unity project, the unity editor can take some time to load and process the new files.

## Set up the Oculus Quest Device
After downloading the Oculus app and connecting to your account, you will have to set up your Oculus Quest device for the first time.
To do that please follow these steps:

Click on devices in the navigation bar.
![](Files/30.PNG)

Connect your headset to your machine with a USB cable.
![](Files/31.PNG)

![](Files/32.PNG)

>Make sure you have a USB 3 connection.
>
![](Files/33.PNG)

Once the device is connected, put the HMD on. From the home panel, go to settings and click on Oculus Link.

![](Files/34.PNG)

Your oculus link home screen will then be loaded.
![](Files/35.jpeg)


## Set up the Unity Environment
If you are running the project for the first time, you will need to make sure that you have all the packages and settings before you start.

First open the project folder in the Unity Hub. The Unity version used in this project is 2022.1.611.

>Make sure to use the same Unity version

![](Files/35.PNG)

Then, make sure that you have all the unity packages needed to correctly run the project.

![](Files/25.PNG)

If you have a missing package, you can simply add it by installing it from the Unity Registry.
![](Files/26.PNG)

Then go to the Project Settings and make sure that the Oculus Plug-in is checked.

![](Files/27.PNG)
![](Files/28.PNG)
Open one of the scenes that you can locate in the Scenes folder.
![](Files/11.PNG)

## Set up the Scene

### Meshes
To play a scene, you have to manually set up some variables.

First, click on the Scene Creator game object. In the Inspector window, precise the name of the scene you want to load. "scene_2" in our case will load two objects. 

![](Files/12.PNG)
You can change the orientation or coodinates of the objects.

>Make sure that the names of the objects in the .cfg file are exactly the same as the names of the game objects in the scene.
![](Files/16.PNG)


Make sure that only the game objects that you wish to load are checked. 
![](Files/15.PNG)

Uncheck the other objects.
![](Files/14.PNG)

Change the LoadConfig files of each object as you wish.

![](Files/17.PNG)

>Make sure that the sum of the frames to be loaded is less or equal to 300 frames. 

>Make sure that the files corresponding to the depths mentioned in the .cfg files are existant in the Resources directory.
### Point clouds
TODO


### Statistics
You can automatically save statistics of the game to analyze later.

![](Files/13.PNG)
![](Files/24.PNG)

# Trouble-Shooting
If you run into a problem, there could be many reasons for that. Here is a list of possible reasons why that happened. If you still can't figure out the problem, feel free to reach out to Panzer0 on GitHub.
## Project Settings
Make sure that all packages and the project settings are in order.

## Cable Compatibility
 Having a faulty cable or not enough bandwidth can affect your experience. Make sure that you have a USB 3.0 and use the Oculus App to Test the connection.

## Update drivers
If the problem still persists, update your USB drivers.

## Check Components
 Make sure that all components are checked for each game object. 

## Initialization
Make sure you have correctly added all the initialization variables. Check the scene and load configuration files.
Make sure that all frames are present in the Resources directory in with the right depths.

## Power Limitations
One possible reason can be the power consumption limitations in some machines.

## Mising tag
From time to time, the project might return an error about a missing tag, usually called "Button". In order to fix this, simply add a correspondent tag to the project. 
TODO: How to do the above




